<project name="mapgrid" default="build">		
	<property file="build.properties"/>
	<property file="build.user.properties"/>

	<target name="release" depends="build,sign.lib,upload,update.webstart" description="Release"/>

	<macrodef name="googleupload">
		<attribute name="label"/>
		<attribute name="file"/>
		<attribute name="desc"/>
		<sequential>
			<echo>Uploading @{file}...</echo>
			<exec executable="googlecode_upload.py">
				<arg line="-p mapgrid"/>
				<arg line="-l '@{label}'"/>
				<arg line="-s '@{desc}'"/>
				<arg line="-u '${google.code.user}'"/>
				<arg line="-w '${google.code.password}'"/>
				<arg line="'@{file}'"/>
			</exec>
		</sequential>
	</macrodef>
	
	
	<target name="upload"  depends="version">
		<googleupload file="build/mapgrid-${version}.jar" label="Featured,Type-Package,OpSys-All" desc="Wersja: ${version}"/>
		<echo>Uploaded mapgrid-${version}.jar</echo>
	</target>

	<target name="upload.deps">
		<googleupload file="lib/jai/clibwrapper_jiio.jar" label="Dependency" desc="Dependency"/>
		<googleupload file="lib/jai/jai_imageio.jar" label="Dependency" desc="Dependency"/>
		<googleupload file="lib/jai/libclib_jiio.so.jar" label="Dependency" desc="Dependency"/>
		<googleupload file="lib/JavaAPIforKml.jar" label="Dependency" desc="Dependency"/>
		<googleupload file="lib/jcoord-1.0.jar" label="Dependency" desc="Dependency"/>
		<googleupload file="lib/jgoodies-common-1.2.1.jar" label="Dependency" desc="Dependency"/>
		<googleupload file="lib/jgoodies-forms-1.4.2.jar" label="Dependency" desc="Dependency"/>
		<googleupload file="lib/josm-tested.jar" label="Dependency" desc="Dependency"/>
	</target>

	<target name="version" unless="version">
		<exec executable="svn">
			<arg line="up src"/>
			<arg line="--username ${google.code.user}"/>
			<arg line="--password ${google.code.password}"/>
		</exec>
		<exec executable="svnversion" outputproperty="minor.version">
			<arg line="src"/>
		</exec>
		<property name="version" value="${major.version}.${minor.version}"/>
		<echo>Version: ${version}</echo>
	</target>
	
	<target name="build" depends="version">
		<delete dir="build"/>
		<mkdir dir="build"/>
		<jar destfile="build/mapgrid-${version}.jar" basedir="bin">
			<manifest>
				<attribute name="Main-Class" value="${main.class}" />
			</manifest>
		</jar>
		<signjar jar="build/mapgrid-${version}.jar" alias="mapgrid" storepass="${keystore.pass}" keystore="mapgrid.keystore" />
	</target>
	
	<target name="update.webstart" depends="version">
		<copy file="mapgrid.jnlp" todir="webstart" overwrite="true">
			<filterset>
				<filter token="MAIN" value="${main.class}"/>
				<filter token="FILE" value="mapgrid-${version}.jar"/>
				<filter token="JNLP" value="${jnlp.href}"/>
				<filter token="CODEBASE" value="${webstart.codebase}"/>
			</filterset>
		</copy>
		<exec executable="svn">
			<arg line="ci webstart -m 'version ${version}'"/>
			<arg line="--username ${google.code.user}"/>
			<arg line="--password ${google.code.password}"/>
		</exec>
	</target>

	<target name="create.keystore">
		<delete file="mapgrid.keystore" />
		<exec executable="keytool">
			<arg line="-genkeypair" />
			<arg line="-alias mapgrid" />
			<arg line="-validity 36500" />
			<arg line='-dname "CN=Rzymek FIA, OU=FIA, O=FIA, L=Warszawa, S=Mazowieckie, C=US" ' />
			<arg line="-keystore mapgrid.keystore" />
			<arg line='-storepass "${keystore.pass}"' />
		</exec>
	</target>
	
	<target name="sign.lib">
		<signjar alias="mapgrid" storepass="${keystore.pass}" keystore="mapgrid.keystore" lazy="true">
			<path>
				<fileset dir="lib" includes="**/*.jar"/>
			</path>
		</signjar>
	</target>
</project>